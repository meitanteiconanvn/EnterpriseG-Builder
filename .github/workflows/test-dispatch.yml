name: Test ADK Setup

on:
  workflow_dispatch:

jobs:
  test-adk-setup:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup ISO creation tools
      shell: pwsh
      run: |
        Write-Host "Setting up ISO creation tools..."
        
        # Check multiple common locations for oscdimg
        $oscdimgPaths = @(
          "${env:ProgramFiles(x86)}\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\Oscdimg\oscdimg.exe",
          "${env:ProgramFiles}\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\Oscdimg\oscdimg.exe",
          "${env:ProgramFiles(x86)}\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\x86\Oscdimg\oscdimg.exe"
        )
        
        $oscdimgFound = $false
        $oscdimgPath = $null
        
        foreach ($path in $oscdimgPaths) {
          if (Test-Path $path) {
            $oscdimgPath = $path
            $oscdimgFound = $true
            Write-Host "✓ Found oscdimg at: $path" -ForegroundColor Green
            break
          }
        }
        
        if (-not $oscdimgFound) {
          Write-Host "oscdimg not found. Attempting to download oscdimg.exe directly..."
          
          # Method 1: Download oscdimg.exe directly from Microsoft Symbol Server
          $localOscdimgPath = "$PWD\oscdimg.exe"
          $oscdimgUrl = "https://msdl.microsoft.com/download/symbols/oscdimg.exe/3D44737265000/oscdimg.exe"
          
          try {
            Write-Host "Downloading oscdimg.exe from Microsoft Symbol Server..."
            Write-Host "URL: $oscdimgUrl"
            
            $ProgressPreference = 'SilentlyContinue'
            Invoke-WebRequest -Uri $oscdimgUrl -OutFile $localOscdimgPath -UseBasicParsing -ErrorAction Stop
            
            if (Test-Path $localOscdimgPath) {
              $fileSize = (Get-Item $localOscdimgPath).Length / 1KB
              Write-Host "✓ oscdimg.exe downloaded successfully ($([math]::Round($fileSize, 2)) KB)" -ForegroundColor Green
              
              if ($fileSize -gt 100) {
                $oscdimgPath = $localOscdimgPath
                $oscdimgFound = $true
                Write-Host "Using downloaded oscdimg.exe: $oscdimgPath" -ForegroundColor Green
              } else {
                Write-Warning "Downloaded file seems too small ($fileSize KB), might be invalid"
                Remove-Item $localOscdimgPath -Force -ErrorAction SilentlyContinue
              }
            }
          } catch {
            Write-Warning "Failed to download oscdimg.exe directly: $_"
            Remove-Item $localOscdimgPath -Force -ErrorAction SilentlyContinue
          }
          
          # Method 2: Try Chocolatey (if direct download failed)
          if (-not $oscdimgFound) {
            Write-Host "Direct download failed. Trying Chocolatey..."
            $chocoAvailable = Get-Command choco -ErrorAction SilentlyContinue
            
            if ($chocoAvailable) {
              Write-Host "Using Chocolatey to install Windows ADK Deployment Tools..."
              try {
                $chocoOutput = choco install windows-adk-deployment-tools -y --no-progress 2>&1 | Out-String
                Write-Host "Chocolatey output: $chocoOutput"
                
                Start-Sleep -Seconds 30
                
                $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
                
                foreach ($path in $oscdimgPaths) {
                  if (Test-Path $path) {
                    $oscdimgPath = $path
                    $oscdimgFound = $true
                    Write-Host "✓ oscdimg installed via Chocolatey at: $path" -ForegroundColor Green
                    break
                  }
                }
                
                if (-not $oscdimgFound) {
                  $adkBasePaths = @(
                    "${env:ProgramFiles(x86)}\Windows Kits\10\Assessment and Deployment Kit",
                    "${env:ProgramFiles}\Windows Kits\10\Assessment and Deployment Kit"
                  )
                  
                  foreach ($adkBase in $adkBasePaths) {
                    if (Test-Path $adkBase) {
                      Write-Host "Found Windows ADK at: $adkBase"
                      $foundOscdimg = Get-ChildItem -Path $adkBase -Filter "oscdimg.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                      if ($foundOscdimg) {
                        $oscdimgPath = $foundOscdimg.FullName
                        $oscdimgFound = $true
                        Write-Host "✓ Found oscdimg at: $oscdimgPath" -ForegroundColor Green
                        break
                      }
                    }
                  }
                }
              } catch {
                Write-Warning "Chocolatey installation failed: $_"
              }
            }
          }
          
          # Method 3: Try using local adksetup.exe
          if (-not $oscdimgFound) {
            Write-Host "Chocolatey method failed or not available. Trying Windows ADK installer..."
            
            # Check if adksetup.exe exists locally (in Files folder)
            $localAdkInstaller = "$PWD\Files\adksetup.exe"
            $adkInstaller = $null
            
            if (Test-Path $localAdkInstaller) {
              Write-Host "✓ Using local adksetup.exe from Files folder..." -ForegroundColor Green
              $adkInstaller = $localAdkInstaller
            } else {
              Write-Host "Local adksetup.exe not found. Downloading Windows ADK installer..."
              
              $adkUrl = "https://go.microsoft.com/fwlink/?linkid=2289980"
              $adkInstaller = "$PWD\adksetup.exe"
              
              try {
                $ProgressPreference = 'SilentlyContinue'
                $client = New-Object System.Net.WebClient
                $client.DownloadFile($adkUrl, $adkInstaller)
                $client.Dispose()
                
                $fileSize = (Get-Item $adkInstaller).Length / 1MB
                Write-Host "Downloaded installer size: $([math]::Round($fileSize, 2)) MB"
                
                if ($fileSize -lt 1) {
                  Write-Warning "Downloaded file seems too small ($fileSize MB), might be a redirect page."
                  Remove-Item $adkInstaller -Force -ErrorAction SilentlyContinue
                  throw "Downloaded file is too small"
                }
              } catch {
                Write-Warning "Failed to download ADK installer: $_"
                $adkInstaller = $null
              }
            }
            
            if ($adkInstaller -and (Test-Path $adkInstaller)) {
              try {
                Write-Host "Installing Windows ADK (download-only mode, then installing oscdimg component)..."
                
                $downloadFolder = "$PWD\adk_download"
                New-Item -ItemType Directory -Path $downloadFolder -Force | Out-Null
                
                $downloadArgs = "/layout `"$downloadFolder`" /quiet /norestart"
                Write-Host "Running: $adkInstaller $downloadArgs"
                
                $process = Start-Process -FilePath $adkInstaller -ArgumentList $downloadArgs -Wait -PassThru -NoNewWindow
                
                Write-Host "ADK download process exited with code: $($process.ExitCode)"
              
                if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
                  Write-Host "ADK components downloaded. Looking for oscdimg MSI installer..."
                  
                  $oscImgMsiPaths = @(
                    "$downloadFolder\Windows Kits\10\ADK\Installers\Oscdimg (DesktopEditions)-x86_en-us.msi",
                    "$downloadFolder\Windows Kits\10\ADK\Installers\Oscdimg (DesktopEditions)-amd64_en-us.msi",
                    "$downloadFolder\Windows Kits\10\ADK\Installers\Oscdimg*.msi"
                  )
                  
                  $oscImgMsi = $null
                  foreach ($msiPath in $oscImgMsiPaths) {
                    $foundMsi = Get-ChildItem -Path $msiPath -ErrorAction SilentlyContinue | Select-Object -First 1
                    if ($foundMsi) {
                      $oscImgMsi = $foundMsi.FullName
                      Write-Host "Found oscdimg MSI: $oscImgMsi"
                      break
                    }
                  }
                  
                  if (-not $oscImgMsi) {
                    $foundMsi = Get-ChildItem -Path $downloadFolder -Filter "*Oscdimg*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                    if ($foundMsi) {
                      $oscImgMsi = $foundMsi.FullName
                      Write-Host "Found oscdimg MSI (recursive search): $oscImgMsi"
                    }
                  }
                  
                  if ($oscImgMsi -and (Test-Path $oscImgMsi)) {
                    Write-Host "Installing oscdimg component from MSI..."
                    $msiLog = "$PWD\oscdimg_msi_install.log"
                    $msiArgs = @(
                      "/i",
                      "`"$oscImgMsi`"",
                      "/quiet",
                      "/norestart",
                      "/l*v",
                      "`"$msiLog`""
                    )
                    Write-Host "Running: msiexec.exe $($msiArgs -join ' ')"
                    
                    try {
                      $msiProcess = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -Wait -PassThru -NoNewWindow -ErrorAction Stop
                      Write-Host "oscdimg MSI installation exited with code: $($msiProcess.ExitCode)"
                    } catch {
                      Write-Warning "Failed to install MSI: $_"
                      Write-Host "Error details: $($_.Exception.Message)"
                      $msiProcess = New-Object PSObject -Property @{ ExitCode = -1 }
                    }
                    
                    if (Test-Path $msiLog) {
                      Write-Host "MSI installation log (last 20 lines):"
                      Get-Content $msiLog -Tail 20 | ForEach-Object { Write-Host $_ }
                    }
                    
                    if ($msiProcess.ExitCode -eq 0 -or $msiProcess.ExitCode -eq 3010) {
                      Write-Host "Waiting for oscdimg to be available..."
                      Start-Sleep -Seconds 10
                      
                      foreach ($path in $oscdimgPaths) {
                        if (Test-Path $path) {
                          $oscdimgPath = $path
                          $oscdimgFound = $true
                          Write-Host "✓ oscdimg now available at: $path" -ForegroundColor Green
                          break
                        }
                      }
                      
                      if (-not $oscdimgFound) {
                        $adkBasePaths = @(
                          "${env:ProgramFiles(x86)}\Windows Kits\10\Assessment and Deployment Kit",
                          "${env:ProgramFiles}\Windows Kits\10\Assessment and Deployment Kit"
                        )
                        
                        foreach ($adkBase in $adkBasePaths) {
                          if (Test-Path $adkBase) {
                            Write-Host "Searching for oscdimg.exe in: $adkBase"
                            $foundOscdimg = Get-ChildItem -Path $adkBase -Filter "oscdimg.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                            if ($foundOscdimg) {
                              $oscdimgPath = $foundOscdimg.FullName
                              $oscdimgFound = $true
                              Write-Host "✓ Found oscdimg at: $oscdimgPath" -ForegroundColor Green
                              break
                            }
                          }
                        }
                      }
                    }
                  } else {
                    Write-Warning "Could not find oscdimg MSI installer in downloaded ADK folder"
                  }
                  
                  Remove-Item -Path $downloadFolder -Recurse -Force -ErrorAction SilentlyContinue
                } else {
                  Write-Warning "ADK download process exited with code: $($process.ExitCode)"
                }
                
                if ($adkInstaller -like "*\adksetup.exe" -and $adkInstaller -notlike "*Files\adksetup.exe") {
                  Remove-Item $adkInstaller -Force -ErrorAction SilentlyContinue
                }
              } catch {
                Write-Warning "Failed to download/install Windows ADK: $_"
                Write-Host "Error details: $($_.Exception.Message)"
              }
            }
          }
        }
        
        # Test result
        Write-Host ""
        Write-Host "========== TEST RESULT ==========" -ForegroundColor Cyan
        if ($oscdimgFound) {
          Write-Host "✓ SUCCESS: oscdimg.exe is available" -ForegroundColor Green
          Write-Host "Path: $oscdimgPath" -ForegroundColor Green
          
          # Test if oscdimg can run
          Write-Host ""
          Write-Host "Testing oscdimg.exe..."
          $testResult = & $oscdimgPath 2>&1 | Out-String
          Write-Host "oscdimg help output (first 10 lines):"
          ($testResult -split "`n")[0..10] | ForEach-Object { Write-Host $_ }
        } else {
          Write-Host "✗ FAILED: oscdimg.exe is not available" -ForegroundColor Red
          Write-Host "All installation methods failed." -ForegroundColor Red
          exit 1
        }
        Write-Host "=================================" -ForegroundColor Cyan

